#! /bin/bash
source etl_env.shinclude

if [[ "${#}" -lt "2" ]]; then
    echo "Need at least two arguments!" >&2
    exit 1
fi

from=$1
to=$2

now=$(date +'%Y-%m-%d')

log_dir="./log/initial/${now}"
mkdir -p "${log_dir}"
log="${log_dir}/${from}.to.${to}.at.$(date +'%H%M')"
out_log="${log}.log"
err_log="${log}.err"

# Printed to command line:
echo "${out_log}"


echo "[IMPORT] STARTING import at $(date +'%Y%m%d %H%M')" >> "${out_log}"
echo "" >> "${out_log}"

cmd='"${KETTLE_LIBS}/../kitchen.sh" \
    -file "${ETL_HOME}/jobs/initial_import.kjb" \
    -param:"ZOOKEEPER_HOST=${zookeeper_host}" \
    -param:"FROM_ID=${from}" \
    -param:"TO_ID=${to}" $mode_param \
    -level:Rowlevel'

mode_param=""
if [[ "${#}" -gt "2" ]]; then
    start_time="$3"
    echo "Using incremental mode from ${start_time}."
    incremental_param="'-param:is_initial_import=false' '-param:OVERRIDE_START_TIME=${start_time}'"
    cmd='"${KETTLE_LIBS}/../pan.sh" "/file:${ETL_HOME}/transformations/lily_update_bug_versions.ktr" \
        -param:"OVERRIDE_START_TIME=${start_time}" \
        -param:"BUG_IDS_PARTITION=bug_id >= ${from} and bug_id < ${to}" \
        -param:"lily_zk_connect_string=${zookeeper_host}" \
        ${mode_param} \
        -level:Rowlevel'
fi

echo "CMD: $cmd"
# do it
JAVAMAXMEM=2048 eval $cmd <&- >> "${out_log}" 2>>"${err_log}" || exit 1


echo "" >> "${out_log}"
echo "[IMPORT] Commiting Solr index:" >> "${out_log}"
curl -s "http://${solr_host}/solr/update" -H 'Content-type:text/xml' --data-binary '<commit/>' >> "${out_log}" 2>>"${err_log}"

echo "[IMPORT] DONE WITH import from bug #${from} to #${to}, time: $(date)" >> "${out_log}"
