#! /bin/bash
source settings.shinclude

if [[ "${#}" -lt "2" ]]; then
    echo "Need at least two arguments!" >&2
    exit 1
fi

from=$1
to=$2

start_date=$(date +'%Y-%m-%d')

log_dir="./log/import/${start_date}"
mkdir -p "${log_dir}"
log="${log_dir}/${from}.to.${to}.at.$(date +'%H%M')"
out_log="${log}.log"
err_log="${log}.err"

# Printed to command line:
echo "less ${out_log}"


echo "[IMPORT] STARTING import at $(date +'%Y%m%d %H%M')" >> "${out_log}"
echo "" >> "${out_log}"

cmd='"${KETTLE_LIBS}/../kitchen.sh" \
    -file "${ETL_HOME}/jobs/import.kjb" \
    -param:"ES_NODES=${ES_NODES}" \
    -param:"ES_CLUSTER=${ES_CLUSTER}" \
    -param:"FROM_ID=${from}" \
    -param:"TO_ID=${to}"'

echo "CMD: $cmd"
# do it
JAVAMAXMEM=4096 eval $cmd <&- >> "${out_log}" 2>>"${err_log}" || exit 1

end_date=$(date +'%Y-%m-%d')
echo -n "[IMPORT] DONE! From #${from} to #${to} " >> "${out_log}"
echo    "(start=${start_date}, end=${end_date})"  >> "${out_log}"
