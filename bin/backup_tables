#! /bin/bash
source settings.shinclude
source bin/management.shinclude

# Modify the classpath (YMMV):
# Get hbase conf out there (e.g. for zk quorum location)
export HADOOP_CLASSPATH="/etc/hbase/conf/:$HADOOP_CLASSPATH"
# Get zk out there (hadoop does not know about zk, but hbase export needs it)
export HADOOP_CLASSPATH="${HBASE_HOME}/lib/zookeeper.jar:$HADOOP_CLASSPATH"
# Google collections API is used by the export task
export HADOOP_CLASSPATH="${HBASE_HOME}/lib/guava-r05.jar:$HADOOP_CLASSPATH"

# Export all versions
MAX=2147483647

date_prefix="$(date +'%Y%m%d_%H%M')"
backup_directory=hdfs://${HDFS_HOST}/user/${USER}/lily_backup/${date_prefix}
hadoop fs -mkdir "${backup_directory}"

for source in $TABLES;
do
    dest="${backup_directory}/${source}"
    echo "DEST: $dest"
    echo "HADOOP_CLASSPATH: $HADOOP_CLASSPATH"
    echo
    hadoop jar "${HBASE_HOME}/hbase.jar" export "${source}" "${dest}" "${MAX}"
done
