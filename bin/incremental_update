#! /bin/bash
project_dir=$(dirname "${0}")/..
cd "${project_dir}"
source settings.shinclude

mkdir -p ./log/incremental/

CLASSPATH=./configuration/hbase-client JAVAMAXMEM=2048 "${KETTLE_LIBS}/../kitchen.sh" \
        -file "${ETL_HOME}/jobs/incremental_update.kjb" \
        -param:"ZOOKEEPER_HOST=${ZOOKEEPER_HOST}" \
    > "${ETL_HOME}/log/incremental/stdout_$(date +%Y%m%d_%H%M%S)" \
    2> "${ETL_HOME}/log/incremental/stderr_$(date +%Y%m%d_%H%M%S)" || exit 1

# Todo: do this in the ETL, depending on success of last update
new_date=$(date --date "now -2 hours" +"%F %T")
echo "Updating start date for next incremental update to ${new_date}"
cat jobs/incremental_update.kjb.template | sed -r 's/\$\{INCREMENTAL_BASE_DATE\}/'"${new_date}"'/' > jobs/incremental_update.kjb

# Give Lily some time for indexing before comitting the Solr indexes
sleep 15
./bin/index_commit
